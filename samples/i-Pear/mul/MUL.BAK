N EQU 2
MULA EQU 176
MULA_END EQU 176+N
MULB EQU 192
MULB_END EQU 192+N
RES EQU 208
RES_END EQU 208+N*2
A_POS EQU 224
B_POS EQU 225
BUF EQU 226

; A_POS: MULA POS
; B_POS: MULB POS
LD A,#MULA
STO A_POS,A
LOOP1:
LD A,#MULB
STO B_POS,A
LOOP2:

; DO MUL
;PLACE
LD A,A_POS  ;NUM 1->R2
STO R2,A
LD A,@R2
STO R2,A

LD A,B_POS   ;NUM 2->R3
STO R3,A
LD A,@R3
STO R3,A

LD R0,#0     ; RESULT (R0,R1)
LD R1,#0
LD A,#128      ; BIT POINTER
STO BUF,A

LAST0:
LD A,BUF
AND A,R3
JZ OP_0_0
OP_0_1:
; DO ADD
LD A,0
ADDC A,#0

LD A,R1
ADDC A,R2
STO R1,A

LD A,R0
ADDC A,#0
STO R0,A
JMP ENDING_1
OP_0_0:
; NO OPERATION
JMP ENDING_0

LAST1:
LD A,BUF
AND A,R3
JZ OP_1_0
OP_1_1:
; NO OPERATION
JMP ENDING_1
OP_1_0:
; DO MINUS
LD A,#0
ADDC A,#0

LD A,R1
SUBC A,R2
STO R1,A

LD A,R0
SUBC A,#0
STO R0,A

JMP ENDING_0

ENDING:

; MODIFY BIT POINTER
ENDING_0:
; SHL RES
CLEAR #0
SHLC R1
SHLC R0

SHR BUF

JZ MUL_END
JMP LAST0

ENDING_1:
; SHL RES
CLEAR #0
SHLC R1
SHLC R0

SHR BUF
JZ MUL_LAST
JMP LAST1

; DEAL WITH BIT[-1]=0
MUL_LAST:
CLEAR #0

LD A,R1
SUBC A,R2
STO R1,A

SUBC R0,#0

MUL_END:

; (R0,R1)=[POS_A]*[POS_B]
LD A,A_POS
SUB A,#MULA
ADD A,B_POS
SUB A,#MULB
ADD A,#RES
ADD A,#1
STO R3,A
; WRITE ADDRESS POINTER: R3
CLEAR #0

LD A,@R3
ADDC A,R1
STO @R3,A
LD A,R3
DEC A,#1
STO R3,A

LD A,@R3
ADDC A,R0
STO @R3,A
LD A,R3
DEC A,#1
STO R3,A

START:
JC LAB1
; IF HASN'T CYN
JMP CEND
LAB1:
LD R2,#0
LD A,@R3
ADDC A,R2
STO @R3,A
LD A,R3
DEC A,#1
STO R3,A
JMP START
CEND: ;CYN FINISHED
ADD B_POS,#1
SUBC A,#MULB_END
JZ LOOP2_EXIT
JMP LOOP2
LOOP2_EXIT:
ADD A_POS,#1
SUBC A,#MULA_END
JZ LOOP1_EXIT
JMP LOOP1
LOOP1_EXIT:

ENDLESS_LOOP:
JMP ENDLESS_LOOP


END
